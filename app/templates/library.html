<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Library</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .book-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; }
        .book-cover { width: 100%; height: 200px; object-fit: contain; margin-bottom: 15px; background-color: #f8f9fa; border-radius: 4px; }
        .book-info { flex-grow: 1; }
        .book-title { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .book-meta { color: #666; font-size: 0.9em; margin-bottom: 15px; }
        .btn { display: inline-block; background: #3498db; color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9em; border: none; cursor: pointer; }
        .btn:hover { background: #2980b9; }

        /* Upload Area Styles */
        .upload-container { background: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        #drop-zone { border: 2px dashed #3498db; border-radius: 8px; padding: 40px; cursor: pointer; transition: background 0.3s, border-color 0.3s; }
        #drop-zone.dragover { background: #ebf5fb; border-color: #2980b9; }
        #drop-zone p { margin: 0; color: #5dade2; font-size: 1.1em; }
        #drop-zone span { font-size: 0.9em; color: #999; }
        
        #progress-container { margin-top: 20px; display: none; }
        .progress-bar-bg { background: #eee; border-radius: 10px; height: 10px; overflow: hidden; }
        .progress-bar-fill { background: #3498db; height: 100%; width: 0%; transition: width 0.1s; }
        #progress-text { font-size: 0.8em; color: #666; margin-top: 5px; }

        .sort-controls { display: flex; gap: 10px; }
        .active-sort { font-weight: bold; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px;">
            <h1 style="margin: 0; border: none;">Library</h1>
            <div class="sort-controls">
                <a href="/?sort=upload" class="btn {% if current_sort == 'upload' %}active-sort{% endif %}" style="background: {% if current_sort == 'upload' %}#2980b9{% else %}#bdc3c7{% endif %};">By Upload</a>
                <a href="/?sort=opened" class="btn {% if current_sort == 'opened' %}active-sort{% endif %}" style="background: {% if current_sort == 'opened' %}#2980b9{% else %}#bdc3c7{% endif %};">By Last Read</a>
            </div>
        </div>

        <div class="upload-container">
            <div id="drop-zone">
                <p>Drag EPUB files here or click to upload</p>
                <span>Supports multiple files</span>
                <input type="file" id="file-input" name="files" accept=".epub" multiple style="display: none;">
            </div>
            
            <div id="progress-container">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-bar-fill"></div>
                </div>
                <div id="progress-text">Uploading... 0%</div>
            </div>
        </div>

        <script>
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const progressContainer = document.getElementById('progress-container');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const progressText = document.getElementById('progress-text');

            dropZone.onclick = () => fileInput.click();

            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            };

            dropZone.ondragleave = () => {
                dropZone.classList.remove('dragover');
            };

            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            };

            fileInput.onchange = () => {
                handleFiles(fileInput.files);
            };

            function handleFiles(files) {
                if (files.length === 0) return;
                
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    if (files[i].name.toLowerCase().endsWith('.epub')) {
                        formData.append('files', files[i]);
                    }
                }

                if (formData.getAll('files').length === 0) {
                    alert('Please select EPUB files.');
                    return;
                }

                uploadFiles(formData);
            }

            function uploadFiles(formData) {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/upload', true);

                progressContainer.style.display = 'block';
                dropZone.style.pointerEvents = 'none';
                dropZone.style.opacity = '0.5';

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBarFill.style.width = percent + '%';
                        progressText.innerText = `Uploading and processing... ${percent}%`;
                        if (percent === 100) {
                            progressText.innerText = 'Conversion in progress... Please wait.';
                        }
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200 || xhr.responseURL) {
                        // Success - reload page
                        window.location.href = '/';
                    } else {
                        alert('Upload failed: ' + xhr.statusText);
                        resetUpload();
                    }
                };

                xhr.onerror = () => {
                    alert('Upload error.');
                    resetUpload();
                };

                xhr.send(formData);
            }

            function resetUpload() {
                progressContainer.style.display = 'none';
                dropZone.style.pointerEvents = 'auto';
                dropZone.style.opacity = '1';
                progressBarFill.style.width = '0%';
                fileInput.value = '';
            }
        </script>

        {% if not books %}
            <p>No processed books found. Upload an EPUB file above to get started!</p>
        {% endif %}

        <div class="book-grid">
            {% for book in books %}
            <div class="book-card">
                {% if book.cover_url %}
                    <img src="{{ book.cover_url }}" alt="Cover" class="book-cover">
                {% else %}
                    <div class="book-cover" style="display: flex; align-items: center; justify-content: center; color: #ccc;">No Cover</div>
                {% endif %}
                <div class="book-info">
                    <div class="book-title">{{ book.title }}</div>
                    <div class="book-meta">
                        {{ book.author }}<br>
                        {{ book.chapters }} sections
                    </div>
                    <a href="/read/{{ book.id }}/0" class="btn">Read Book</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</body>
</html>
